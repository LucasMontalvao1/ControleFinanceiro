<div class="page-container">
    <div class="page-header">
        <div class="header-info">
            <h1>Transações Recorrentes</h1>
            <p>Gerencie despesas e receitas fixas mensais</p>
        </div>

        <div class="header-actions">
            <div class="date-navigator">
                <button class="nav-btn" (click)="changeMonth(-1)">
                    <lucide-icon name="ChevronLeft"></lucide-icon>
                </button>
                <span class="current-month">{{ currentMonthName() }}</span>
                <button class="nav-btn" (click)="changeMonth(1)">
                    <lucide-icon name="ChevronRight"></lucide-icon>
                </button>
            </div>
            <button class="btn-secondary" (click)="applyToMonth()" [disabled]="recorrentes().length === 0">
                <lucide-icon name="RefreshCw"></lucide-icon>
                <span>Aplicar ao Mês</span>
            </button>
            <button class="btn-primary" (click)="openAddModal()">
                <lucide-icon name="Plus"></lucide-icon>
                <span>Nova Recorrente</span>
            </button>
        </div>
    </div>

    <!-- Info Box -->
    <div class="info-box">
        <div class="info-icon">
            <lucide-icon name="Calendar"></lucide-icon>
        </div>
        <div class="info-content">
            <h4>Como funciona?</h4>
            <p>As transações recorrentes são despesas ou receitas fixas que se repetem todo mês. Selecione o mês acima e
                clique em
                "Aplicar ao Mês" para gerar os lançamentos automaticamente.</p>
        </div>
    </div>

    <div class="recorrentes-list">
        @if (loading()) {
        <div class="loading-state">
            <div class="spinner"></div>
        </div>
        } @else if (recorrentes().length === 0) {
        <div class="empty-state">
            <lucide-icon name="Repeat"></lucide-icon>
            <p>Nenhuma transação recorrente cadastrada.</p>
            <button class="btn-outline" (click)="openAddModal()">Cadastrar primeira</button>
        </div>
        } @else {
        @for (item of recorrentes(); track item.id) {
        <div class="recorrente-card">
            <div class="item-icon" [class.receita]="item.tipo === 'Receita'">
                <lucide-icon [name]="item.tipo === 'Receita' ? 'TrendingUp' : 'TrendingDown'"></lucide-icon>
            </div>
            <div class="item-info">
                <span class="desc">{{ item.descricao }}</span>
                <span class="meta">{{ item.categoriaNome }} • Todo dia {{ item.diaVencimento }}</span>
            </div>
            <div class="item-value" [class.receita]="item.tipo === 'Receita'">
                {{ item.tipo === 'Receita' ? '+' : '-' }} {{ item.valor | currency:'BRL':'symbol':'1.2-2' }}
            </div>
            <div class="item-actions">
                <div class="toggle-switch">
                    <input type="checkbox" [id]="'toggle-' + item.id" [checked]="item.ativo"
                        (change)="toggleAtivo(item)">
                    <label [for]="'toggle-' + item.id"></label>
                </div>
                <button class="icon-btn" title="Editar" (click)="openEditModal(item)">
                    <lucide-icon name="Pencil"></lucide-icon>
                </button>
                <button class="icon-btn delete" title="Excluir" (click)="confirmDelete(item)">
                    <lucide-icon name="Trash2"></lucide-icon>
                </button>
            </div>
        </div>
        }
        }
    </div>

    <!-- Modal Form -->
    @if (showModal()) {
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>{{ editMode() ? 'Editar' : 'Nova' }} Recorrência</h2>
                <button class="close-btn" (click)="closeModal()">
                    <lucide-icon name="X"></lucide-icon>
                </button>
            </div>

            <form (ngSubmit)="save()" #recorrenteForm="ngForm">
                <div class="form-group">
                    <label>Descrição</label>
                    <input type="text" name="descricao" [(ngModel)]="form.descricao"
                        placeholder="Ex: Aluguel, Internet..." required>
                </div>

                <div class="form-row">
                    <div class="form-group flex-1">
                        <label>Valor</label>
                        <input type="number" name="valor" [(ngModel)]="form.valor" placeholder="0,00" step="0.01"
                            required>
                    </div>
                    <div class="form-group flex-1">
                        <label>Dia de Vencimento</label>
                        <input type="number" name="dia" [(ngModel)]="form.diaVencimento" min="1" max="31" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group flex-1">
                        <label>Tipo</label>
                        <select name="tipo" [(ngModel)]="form.tipo">
                            <option value="Saida">Despesa</option>
                            <option value="Receita">Receita</option>
                        </select>
                    </div>
                    <div class="form-group flex-1">
                        <label>Categoria</label>
                        <select name="categoria" [(ngModel)]="form.categoriaId" required>
                            <option [value]="0" disabled>Selecione...</option>
                            @for (cat of categorias(); track cat.id) {
                            <option [value]="cat.id">{{ cat.nome }}</option>
                            }
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-outline" (click)="closeModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    }
</div>